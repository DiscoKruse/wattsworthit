<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watts Worth It - Bitcoin Mining Calculator</title>

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <!-- YOUR ORIGINAL CSS UNCHANGED -->
    <style>
        /* --- CSS OMITTED FOR BREVITY ---
           Paste your full existing CSS here unchanged.
           (No CSS changes required for this integration.)
        */
    </style>
</head>

<body data-theme="dark">
<div class="theme-toggle" id="themeToggle">‚òÄÔ∏è Light Mode</div>

<div class="container">
    <h1>‚ö° Watts Worth It</h1>
    <p class="subtitle">Calculate your Bitcoin mining breakeven efficiency</p>

    <div class="inputs-section">
        <div class="input-row">
            <div class="input-group">
                <label for="electricityCost">Electricity Cost:</label>
                <div class="input-controls">
                    <input type="number" id="electricityCost" value="0.10" step="0.01" min="0" max="0.50">
                    <div class="slider-container">
                        <span>$0.00</span>
                        <input type="range" id="electricitySlider" class="slider"
                               min="0" max="0.50" step="0.01" value="0.10">
                        <span>$0.50</span>
                    </div>
                </div>
                <span>$/kWh</span>
            </div>
        </div>

        <div class="input-row">
            <div class="input-group">
                <label for="revenue">Revenue per TH/day:</label>
                <div class="input-controls">
                    <!-- DEFAULT FALLBACK VALUE -->
                    <input type="number" id="revenue" value="0.055"
                           step="0.001" min="0" max="0.200">
                    <div class="slider-container">
                        <span>$0.00</span>
                        <input type="range" id="revenueSlider" class="slider"
                               min="0" max="0.200" step="0.001" value="0.055">
                        <span>$0.20</span>
                    </div>
                </div>
                <span>$</span>
            </div>
        </div>

        <!-- STATUS LINE -->
        <div style="text-align:center; font-size:0.9em; opacity:0.85;" id="revenueStatus">
            Revenue source: default
        </div>
    </div>

    <div class="result-section">
        <h2>Breakeven Mining Efficiency</h2>
        <div class="result-value" id="breakevenResult">‚Äî</div>
        <div class="result-explanation">
            Miners with <strong>lower</strong> J/TH/s values than this number will be profitable.<br>
            Lower J/TH/s = more efficient = more profitable
        </div>
    </div>

    <!-- CHART + FORMULA SECTIONS UNCHANGED -->
</div>

<!-- ========================================================= -->
<!-- üîß NEW: SAME-ORIGIN REVENUE LOADER (NO CORS ISSUES) -->
<!-- ========================================================= -->
<script>
async function loadRevenueFromServer() {
    try {
        const res = await fetch("/revenue.php", { cache: "no-store" });
        if (!res.ok) throw new Error("Revenue API failed");

        const data = await res.json();

        if (!Number.isFinite(data.usdPerDayPerTH)) {
            throw new Error("Invalid revenue payload");
        }

        const revenue = data.usdPerDayPerTH;

        const revenueInput = document.getElementById("revenue");
        const revenueSlider = document.getElementById("revenueSlider");
        const revenueStatus = document.getElementById("revenueStatus");

        revenueInput.value = revenue.toFixed(5);
        revenueSlider.value = Math.min(revenue, 0.2).toFixed(5);

        revenueStatus.textContent =
            `Revenue source: public on-chain data ‚Ä¢ ${revenue.toFixed(5)} $/TH/day`;

        // Recompute once applied
        window.calculator.calculateBreakeven();
        window.calculator.updateChart();

    } catch (err) {
        console.warn("Revenue update failed, using default:", err);
    }
}
</script>

<!-- ========================================================= -->
<!-- üßÆ YOUR ORIGINAL CALCULATOR LOGIC (UNCHANGED) -->
<!-- ========================================================= -->
<script>
class BitcoinMiningCalculator {
    constructor() {
        this.initializeElements();
        this.setupEventListeners();
        this.loadUserData();
        this.calculateBreakeven();
        this.updateChart();
    }

    initializeElements() {
        this.electricityCostInput = document.getElementById('electricityCost');
        this.electricitySlider = document.getElementById('electricitySlider');
        this.revenueInput = document.getElementById('revenue');
        this.revenueSlider = document.getElementById('revenueSlider');
        this.breakevenResult = document.getElementById('breakevenResult');
        this.themeToggle = document.getElementById('themeToggle');
    }

    setupEventListeners() {
        this.electricityCostInput.addEventListener('input', () => {
            this.electricitySlider.value = this.electricityCostInput.value;
            this.calculateBreakeven();
            this.updateChart();
            this.saveUserData();
        });

        this.revenueInput.addEventListener('input', () => {
            this.revenueSlider.value = this.revenueInput.value;
            this.calculateBreakeven();
            this.updateChart();
            this.saveUserData();
        });

        this.electricitySlider.addEventListener('input', () => {
            this.electricityCostInput.value = this.electricitySlider.value;
            this.calculateBreakeven();
            this.updateChart();
            this.saveUserData();
        });

        this.revenueSlider.addEventListener('input', () => {
            this.revenueInput.value = this.revenueSlider.value;
            this.calculateBreakeven();
            this.updateChart();
            this.saveUserData();
        });

        this.themeToggle.addEventListener('click', () => this.toggleTheme());
    }

    toggleTheme() {
        const body = document.body;
        const theme = body.getAttribute("data-theme") === "dark" ? "light" : "dark";
        body.setAttribute("data-theme", theme);
        localStorage.setItem("theme", theme);
        this.themeToggle.textContent = theme === "dark" ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
    }

    calculateBreakeven() {
        const electricity = parseFloat(this.electricityCostInput.value) || 0.10;
        const revenue = parseFloat(this.revenueInput.value) || 0.055;
        const breakeven = (revenue * 41.66667) / electricity;
        this.breakevenResult.textContent = `${breakeven.toFixed(2)} J/TH/s`;
    }

    updateChart() {
        /* your existing chart logic unchanged */
    }

    saveUserData() {
        localStorage.setItem("bitcoinMiningCalculator", JSON.stringify({
            electricityCost: this.electricityCostInput.value,
            revenue: this.revenueInput.value
        }));
    }

    loadUserData() {
        try {
            const saved = JSON.parse(localStorage.getItem("bitcoinMiningCalculator") || "{}");
            if (saved.electricityCost) {
                this.electricityCostInput.value = saved.electricityCost;
                this.electricitySlider.value = saved.electricityCost;
            }
            if (saved.revenue) {
                this.revenueInput.value = saved.revenue;
                this.revenueSlider.value = saved.revenue;
            }
        } catch {}
    }
}

// INITIALIZATION ORDER MATTERS
document.addEventListener("DOMContentLoaded", () => {
    window.calculator = new BitcoinMiningCalculator();
    loadRevenueFromServer(); // üî• automatic, no CORS
});
</script>
</body>
</html>
